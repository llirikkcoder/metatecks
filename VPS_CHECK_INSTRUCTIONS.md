# Инструкция по проверке VPS перед развертыванием Docker

## Цель
Скрипт `vps_check.sh` собирает полную информацию о текущем состоянии VPS сервера, чтобы безопасно развернуть новое Docker приложение параллельно с уже работающим приложением.

## Что проверяет скрипт

1. **Системная информация** - ОС, CPU, память, диски
2. **Сеть и порты** - какие порты заняты, какие свободны
3. **Запущенные сервисы** - systemd, supervisor
4. **Веб-серверы** - Nginx/Apache конфигурация
5. **Базы данных** - PostgreSQL, MySQL, Redis
6. **Python окружения** - версии, виртуальные окружения
7. **Docker** - установлен ли, какие контейнеры запущены
8. **Процессы приложений** - gunicorn, uwsgi, celery
9. **Директории приложений** - где находятся проекты
10. **Firewall** - правила файрвола
11. **Nginx конфигурация** - детальный анализ
12. **Доступность портов** - какие порты можно использовать для Docker

## Как использовать

### Вариант 1: Запуск на локальном VPS
```bash
# Скопируйте скрипт на сервер
scp vps_check.sh user@your-vps.com:/tmp/

# Подключитесь к серверу и запустите
ssh user@your-vps.com
cd /tmp
chmod +x vps_check.sh
sudo bash vps_check.sh > vps_report.txt

# Скопируйте отчет обратно
exit
scp user@your-vps.com:/tmp/vps_report.txt .
```

### Вариант 2: Запуск и получение отчета одной командой
```bash
# Скопируйте, запустите и получите отчет
scp vps_check.sh user@your-vps.com:/tmp/ && \
ssh user@your-vps.com "sudo bash /tmp/vps_check.sh" > vps_report.txt
```

### Вариант 3: Если у вас уже есть доступ к серверу
```bash
# Просто запустите на сервере
sudo bash vps_check.sh | tee vps_report.txt
```

## Что делать с отчетом

1. **Сохраните отчет** - файл `vps_report.txt` содержит полную информацию о сервере
2. **Изучите секции**:
   - Раздел 2 (NETWORK & PORTS) - какие порты заняты
   - Раздел 4 (WEB SERVERS) - как настроен Nginx
   - Раздел 5 (DATABASES) - какие БД запущены и на каких портах
   - Раздел 12 (PORT AVAILABILITY) - какие порты свободны для Docker
3. **Поделитесь со мной** - отправьте содержимое файла, я проанализирую и дам рекомендации

## Примеры рекомендаций на основе отчета

### Если порт 8001 свободен:
```yaml
# docker-compose.yml
services:
  web:
    ports:
      - "127.0.0.1:8001:8000"  # Новое приложение на 8001
```

```nginx
# /etc/nginx/sites-available/new-app
server {
    listen 80;
    server_name new.example.com;

    location / {
        proxy_pass http://127.0.0.1:8001;
    }
}
```

### Если PostgreSQL уже запущен на порту 5432:
```yaml
# docker-compose.yml
services:
  db:
    ports:
      - "127.0.0.1:5433:5432"  # Новая БД на 5433
```

### Если Redis уже запущен на порту 6379:
```yaml
# docker-compose.yml
services:
  redis:
    ports:
      - "127.0.0.1:6380:6379"  # Новый Redis на 6380
```

## Безопасность

⚠️ **Внимание**: Скрипт требует `sudo` для доступа к некоторой информации (открытые порты, nginx конфигурация).

Скрипт только **читает** информацию, не вносит никаких изменений в систему.

## Устранение проблем

### Ошибка: permission denied
```bash
# Убедитесь что запускаете с sudo
sudo bash vps_check.sh
```

### Ошибка: netstat/ss not found
Скрипт попробует оба варианта. Если оба отсутствуют, установите:
```bash
# Ubuntu/Debian
sudo apt-get install net-tools

# CentOS/RHEL
sudo yum install net-tools
```

### Некоторые секции пустые
Это нормально - значит соответствующее ПО не установлено на сервере.

## Следующие шаги

После получения отчета:

1. ✅ Изучите занятые порты
2. ✅ Проверьте конфигурацию Nginx
3. ✅ Определите свободные порты для Docker
4. ✅ Отправьте мне отчет для анализа
5. ✅ Получите персонализированную инструкцию по развертыванию

## Автоматический анализ

После получения отчета я автоматически:
- Определю оптимальные порты для Docker контейнеров
- Подготовлю конфигурацию docker-compose.yml
- Создам конфигурацию Nginx для нового приложения
- Дам рекомендации по безопасному развертыванию
- Укажу на потенциальные конфликты

## Контрольный список перед запуском

- [ ] У вас есть SSH доступ к VPS
- [ ] У вас есть sudo права
- [ ] Скрипт скопирован на сервер
- [ ] Готовы сохранить отчет локально
- [ ] Готовы поделиться отчетом для анализа
