# Development окружение с hot-reload
# Запуск: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  # База данных PostgreSQL (без изменений)
  db:
    ports:
      - "5432:5432"  # Открываем порт для отладки

  # Redis для Celery (без изменений)
  redis:
    ports:
      - "6379:6379"  # Открываем порт для отладки

  # Django приложение (Development режим с hot-reload)
  web:
    build:
      context: .
      dockerfile: Dockerfile.dev
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      # В dev режиме монтируем код для hot-reload
      - .:/app
      - static_volume:/app/static
      - ./media:/app/media
      - ./logs:/app/logs
      # Исключаем виртуальное окружение и кеш Python
      - /app/__pycache__
      - /app/.venv
    environment:
      - DJANGO_DEBUG=True
      - DJANGO_SETTINGS_MODULE=main.settings
    # Отключаем healthcheck для быстрого старта в dev
    healthcheck:
      disable: true

  # Celery Worker (Development режим)
  celery:
    build:
      context: .
      dockerfile: Dockerfile.dev
    volumes:
      # В dev режиме монтируем код
      - .:/app
      - ./media:/app/media
      - ./logs:/app/logs
      - /app/__pycache__
      - /app/.venv
    environment:
      - DJANGO_DEBUG=True
      - CELERY_LOG_LEVEL=debug

  # Celery Beat (раскомментируйте если используете)
  # celery-beat:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.dev
  #   volumes:
  #     - .:/app
  #     - /app/__pycache__
  #     - /app/.venv
  #   environment:
  #     - DJANGO_DEBUG=True

  # Nginx (Development)
  nginx:
    volumes:
      # Конфигурация nginx
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
      # В dev режиме монтируем напрямую для быстрого тестирования
      - static_volume:/app/static:ro
      - ./media:/app/media:ro
      - ./assets:/app/assets:ro  # В dev assets монтируются напрямую
    ports:
      - "80:80"
      # Можно добавить альтернативный порт для dev
      # - "8080:80"

# Volumes используются те же, что и в production
volumes:
  static_volume:

networks:
  metateks_network:
