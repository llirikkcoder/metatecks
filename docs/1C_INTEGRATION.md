# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å 1–° (CommerceML)

## üìã –û–±–∑–æ—Ä

–ü—Ä–æ–µ–∫—Ç **–ú–µ—Ç–∞—Ç—ç–∫—Å** –∏–º–µ–µ—Ç –ø–æ–ª–Ω—É—é –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—é—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å 1–° —á–µ—Ä–µ–∑ –ø—Ä–æ—Ç–æ–∫–æ–ª **CommerceML 2.0**.

### ‚úÖ –ß—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –∏–∑ 1–° ‚Üí Django:

1. **–ì—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏)**
   - –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
   - –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —Å–∞–π—Ç–∞

2. **–°–≤–æ–π—Å—Ç–≤–∞ (—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏)**
   - –ù–∞–∑–≤–∞–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞
   - –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è
   - –¢–∏–ø –∑–Ω–∞—á–µ–Ω–∏—è (—Ç–µ–∫—Å—Ç, —á–∏—Å–ª–æ, —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫)
   - –í–∞—Ä–∏–∞–Ω—Ç—ã –∑–Ω–∞—á–µ–Ω–∏–π

3. **–ë—Ä–µ–Ω–¥—ã**
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
   - –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –±—Ä–µ–Ω–¥–∞–º —Å–∞–π—Ç–∞

4. **–¢–æ–≤–∞—Ä—ã –∏ –º–æ–¥–µ–ª–∏**
   - –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
   - –ê—Ä—Ç–∏–∫—É–ª (vendor_code)
   - –®—Ç—Ä–∏—Ö–∫–æ–¥ (bar_code)
   - –û–ø–∏—Å–∞–Ω–∏–µ
   - –¶–µ–Ω–∞
   - **–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤** üì∏
   - –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (—Å–≤–æ–π—Å—Ç–≤–∞)
   - –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –≥—Ä—É–ø–ø–∞–º/–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º

5. **–°–∫–ª–∞–¥—ã**
   - –ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞
   - –ê–¥—Ä–µ—Å
   - –¢–µ–ª–µ—Ñ–æ–Ω
   - –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–∫–ª–∞–¥–∞–º —Å–∞–π—Ç–∞

6. **–û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ –Ω–∞ –∫–∞–∂–¥–æ–º —Å–∫–ª–∞–¥–µ
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞

### ‚úÖ –ß—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –∏–∑ Django ‚Üí 1–°:

1. **–ó–∞–∫–∞–∑—ã**
   - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ
   - –¢–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑–µ
   - –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
   - –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏
   - –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã

---

## üñºÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

#### –®–∞–≥ 1: 1–° –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª—ã –Ω–∞ —Å–∞–π—Ç

1–° –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–º–µ—Å—Ç–µ —Å XML —Ñ–∞–π–ª–∞–º–∏ –Ω–∞ endpoint:
```
POST /1c_exchange.php?type=catalog&mode=file&filename=picture.jpg
```

#### –®–∞–≥ 2: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é

–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤:
```
media/cml/tmp/picture.jpg
```

–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥: `apps/third_party/cml/views.py:43-60`

#### –®–∞–≥ 3: XML —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ

–í XML —Ñ–∞–π–ª–µ `import.xml` —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é:

```xml
<–¢–æ–≤–∞—Ä>
    <–ò–¥>00000001#00000001</–ò–¥>
    <–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>–¢–æ–≤–∞—Ä –Ω–∞–∑–≤–∞–Ω–∏–µ</–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ>
    <–ö–∞—Ä—Ç–∏–Ω–∫–∞>picture.jpg</–ö–∞—Ä—Ç–∏–Ω–∫–∞>
    ...
</–¢–æ–≤–∞—Ä>
```

–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥: `apps/third_party/cml/utils.py:167-175`

#### –®–∞–≥ 4: –ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–ø–∏—Ä—É—é—Ç—Å—è

Celery –∑–∞–¥–∞—á–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–º–ø–æ—Ä—Ç –∏ –∫–æ–ø–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:

```python
# –ò–∑ media/cml/tmp/picture.jpg
# –í   media/models/photos_1c/picture.jpg
```

–ü—Ä–æ—Ü–µ—Å—Å:
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
2. –ö–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `media/models/photos_1c/`
3. –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –º–æ–¥–µ–ª–∏ —Ç–æ–≤–∞—Ä–∞ (`ProductModel.photo`)

–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥: `apps/third_party/cml/sync.py:116-125`

---

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–∞—Ç–∞–ª–æ–≥–∞

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±–º–µ–Ω–∞

**–ó–∞–ø—Ä–æ—Å –æ—Ç 1–°:**
```
GET /1c_exchange.php?type=catalog&mode=checkauth
```

**–û—Ç–≤–µ—Ç Django:**
```
success
PHPSESSID
<session_id>
```

**–ó–∞–ø—Ä–æ—Å –æ—Ç 1–°:**
```
GET /1c_exchange.php?type=catalog&mode=init
```

**–û—Ç–≤–µ—Ç Django:**
```
zip=no
file_limit=0
```

### 2. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤

**1–° –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª—ã:**
```
POST /1c_exchange.php?type=catalog&mode=file&filename=import.xml
POST /1c_exchange.php?type=catalog&mode=file&filename=offers.xml
POST /1c_exchange.php?type=catalog&mode=file&filename=picture1.jpg
POST /1c_exchange.php?type=catalog&mode=file&filename=picture2.jpg
...
```

–§–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `media/cml/tmp/`

### 3. –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö

**–ó–∞–ø—Ä–æ—Å –æ—Ç 1–°:**
```
GET /1c_exchange.php?type=catalog&mode=import&filename=import.xml
```

**Django —Å–æ–∑–¥–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∑–∞–¥–∞—á—É Celery:**

```python
# apps/third_party/cml/views.py:81-85
exchange_obj = Exchange.log('import', request.user, filename)
parsing_obj = ExchangeParsing.log(exchange_obj, filename, file_path)
make_import.delay(parsing_obj_id=parsing_obj.id)
```

**Celery task –≤—ã–ø–æ–ª–Ω—è–µ—Ç:**

1. –ü–∞—Ä—Å–∏–Ω–≥ XML —Ñ–∞–π–ª–∞ (`import.xml`)
   - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≥—Ä—É–ø–ø —Ç–æ–≤–∞—Ä–æ–≤
   - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤
   - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
   - **–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—É—Ç–µ–π –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º**

2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (`ImportedProduct`, `ImportedGroup`, –∏ —Ç.–¥.)

3. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏:
   ```python
   # apps/third_party/cml/tasks.py
   start_sync(modules=['properties', 'products', 'stock_balance', 'products_in_stock'])
   ```

4. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é

### 4. –ò–º–ø–æ—Ä—Ç —Ü–µ–Ω –∏ –æ—Å—Ç–∞—Ç–∫–æ–≤

**–ó–∞–ø—Ä–æ—Å –æ—Ç 1–°:**
```
GET /1c_exchange.php?type=catalog&mode=import&filename=offers.xml
```

**Django –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:**
- –¶–µ–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤
- –û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –Ω–∞–ª–∏—á–∏–∏

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (staging)

1–° –¥–∞–Ω–Ω—ã–µ —Å–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:

- `cml_importedgroup` - –ì—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ 1–°
- `cml_importedproperty` - –°–≤–æ–π—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤
- `cml_importedbrand` - –ë—Ä–µ–Ω–¥—ã
- `cml_importedproduct` - **–¢–æ–≤–∞—Ä—ã —Å –ø—É—Ç—è–º–∏ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º**
- `cml_importedwarehouse` - –°–∫–ª–∞–¥—ã
- `cml_importedstockbalance` - –û—Å—Ç–∞—Ç–∫–∏

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å–∞–π—Ç–∞

–ü–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏:

- `catalog_category` / `catalog_subcategory` ‚Üê `cml_importedgroup`
- `catalog_attribute` ‚Üê `cml_importedproperty`
- `catalog_brand` ‚Üê `cml_importedbrand`
- `catalog_productmodel` ‚Üê `cml_importedproduct` (**—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏**)
- `catalog_product` ‚Üê `cml_importedproduct`
- `addresses_warehouse` ‚Üê `cml_importedwarehouse`
- `catalog_productstockbalance` ‚Üê `cml_importedstockbalance`

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è 1–°

```bash
# –í Docker
docker-compose exec web python manage.py createsuperuser

# –ò–ª–∏ –±–µ–∑ Docker
python manage.py createsuperuser
```

–í–≤–µ–¥–∏—Ç–µ:
- Username: `1c_user` (–∏–ª–∏ –ª—é–±–æ–µ –¥—Ä—É–≥–æ–µ)
- Email: `1c@example.com`
- Password: (–Ω–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å)

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

–í Django Admin (`/admin/`) –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–∞–π—Ç–µ –µ–º—É –ø—Ä–∞–≤–æ:
- **cml | exchange | Can add exchange**

–ò–ª–∏ —á–µ—Ä–µ–∑ Django shell:

```python
from django.contrib.auth.models import User, Permission

user = User.objects.get(username='1c_user')
perm = Permission.objects.get(codename='add_exchange', content_type__app_label='cml')
user.user_permissions.add(perm)
```

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ 1–°

–í 1–° –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¢–æ—Ä–≥–æ–≤–ª–µ–π –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–º–µ–Ω–∞:

**–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
- URL: `http://your-domain.com/1c_exchange.php`
- –õ–æ–≥–∏–Ω: `1c_user`
- –ü–∞—Ä–æ–ª—å: (–ø–∞—Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Django)

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
- –§–æ—Ä–º–∞—Ç –æ–±–º–µ–Ω–∞: **CommerceML 2.0**
- –í—ã–≥—Ä—É–∂–∞—Ç—å: ‚úÖ –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤, ‚úÖ –¶–µ–Ω—ã, ‚úÖ –û—Å—Ç–∞—Ç–∫–∏
- –ó–∞–≥—Ä—É–∂–∞—Ç—å: ‚úÖ –ó–∞–∫–∞–∑—ã

### –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

```bash
# –í Docker
docker-compose exec web mkdir -p /app/media/models/photos_1c
docker-compose exec web mkdir -p /app/media/cml/tmp

# –ò–ª–∏ –±–µ–∑ Docker
mkdir -p media/models/photos_1c
mkdir -p media/cml/tmp
```

### –®–∞–≥ 5: –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

–í 1–° –Ω–∞–∂–º–∏—Ç–µ **"–í—ã–ø–æ–ª–Ω–∏—Ç—å –æ–±–º–µ–Ω"**

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:

```bash
# –í Docker
docker-compose logs -f celery

# –ò–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ
tail -f logs/cml_sync.log
tail -f logs/cml_tasks.log
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
media/
‚îú‚îÄ‚îÄ cml/
‚îÇ   ‚îî‚îÄ‚îÄ tmp/                    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ—Ç 1–°
‚îÇ       ‚îú‚îÄ‚îÄ import.xml          # XML —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º
‚îÇ       ‚îú‚îÄ‚îÄ offers.xml          # XML —Å —Ü–µ–Ω–∞–º–∏/–æ—Å—Ç–∞—Ç–∫–∞–º–∏
‚îÇ       ‚îú‚îÄ‚îÄ picture1.jpg        # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–≤—Ä–µ–º–µ–Ω–Ω–æ)
‚îÇ       ‚îî‚îÄ‚îÄ picture2.jpg
‚îÇ
‚îî‚îÄ‚îÄ models/
    ‚îî‚îÄ‚îÄ photos_1c/              # –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        ‚îú‚îÄ‚îÄ picture1.jpg        # –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        ‚îî‚îÄ‚îÄ picture2.jpg        # –ü—Ä–∏–≤—è–∑–∞–Ω—ã –∫ ProductModel.photo

logs/
‚îú‚îÄ‚îÄ cml_sync.log                # –õ–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ cml_tasks.log               # –õ–æ–≥–∏ Celery –∑–∞–¥–∞—á
‚îî‚îÄ‚îÄ cml_utils.log               # –õ–æ–≥–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ XML
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Admin

–û—Ç–∫—Ä–æ–π—Ç–µ Django Admin:
- `/admin/cml/importedproduct/` - –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
- `/admin/cml/exchange/` - –ò—Å—Ç–æ—Ä–∏—è –æ–±–º–µ–Ω–æ–≤
- `/admin/catalog/productmodel/` - –ú–æ–¥–µ–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ (—Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏)
- `/admin/catalog/product/` - –¢–æ–≤–∞—Ä—ã

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Django Shell

```python
docker-compose exec web python manage.py shell

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
from apps.third_party.cml.models import ImportedProduct
ImportedProduct.objects.count()  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å > 0
ImportedProduct.objects.filter(image_path__isnull=False).count()  # –¢–æ–≤–∞—Ä—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
from apps.catalog.models import ProductModel, Product
ProductModel.objects.filter(is_synced_with_1c=True).count()
ProductModel.objects.filter(photo__isnull=False).count()  # –ú–æ–¥–µ–ª–∏ —Å —Ñ–æ—Ç–æ

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤
from apps.catalog.models import ProductStockBalance
ProductStockBalance.objects.count()

# –ü—Ä–∏–º–µ—Ä —Ç–æ–≤–∞—Ä–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
product = ProductModel.objects.filter(photo__isnull=False).first()
print(f"–ù–∞–∑–≤–∞–Ω–∏–µ: {product.name}")
print(f"–§–æ—Ç–æ: {product.photo.url}")
print(f"ID –∏–∑ 1–°: {product.id_1c}")
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Celery –ª–æ–≥–∏

```bash
docker-compose logs celery | grep "sync"
docker-compose logs celery | grep "ImportedProduct"
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
docker-compose exec web ls -lh /app/media/cml/tmp/

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
docker-compose exec web ls -lh /app/media/models/photos_1c/

# –†–∞–∑–º–µ—Ä –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
docker-compose exec web du -sh /app/media/models/photos_1c/
```

---

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**

1. **–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å**
   ```bash
   docker-compose exec web chmod -R 777 /app/media/cml/tmp
   docker-compose exec web chmod -R 777 /app/media/models/photos_1c
   ```

2. **Celery worker –Ω–µ –∑–∞–ø—É—â–µ–Ω**
   ```bash
   docker-compose ps celery  # –î–æ–ª–∂–µ–Ω –±—ã—Ç—å Up
   docker-compose logs celery
   ```

3. **–ü—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –Ω–µ–≤–µ—Ä–Ω—ã–π**
   ```python
   # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ ImportedProduct
   from apps.third_party.cml.models import ImportedProduct
   p = ImportedProduct.objects.filter(image_path__isnull=False).first()
   print(p.image_path)

   # –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª
   import os
   os.path.exists(p.image_path)
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: –¢–æ–≤–∞—Ä—ã –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–ª–∞–≥ `do_not_sync`:
   ```python
   from apps.third_party.cml.models import ImportedProduct, ImportedGroup
   ImportedProduct.objects.filter(do_not_sync=True).update(do_not_sync=False)
   ImportedGroup.objects.filter(do_not_sync=True).update(do_not_sync=False)
   ```

2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é:
   ```bash
   docker-compose exec web python manage.py shell
   ```
   ```python
   from apps.third_party.cml.sync import start_sync
   start_sync(modules=['products'], is_full=True)
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –æ—Ç 1–°

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
   ```python
   from django.contrib.auth.models import User
   user = User.objects.get(username='1c_user')
   user.has_perm('cml.add_exchange')  # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å True
   ```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   ```bash
   docker-compose logs web | grep "1c_exchange"
   ```

---

## üöÄ –†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

### –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

```bash
docker-compose exec web python manage.py shell
```

```python
from apps.third_party.cml.sync import start_sync

# –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
start_sync(modules=['properties', 'products', 'stock_balance', 'products_in_stock'], is_full=True)
```

### –ß–∞—Å—Ç–∏—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

```python
# –¢–æ–ª—å–∫–æ —Ç–æ–≤–∞—Ä—ã
start_sync(modules=['products'])

# –¢–æ–ª—å–∫–æ –æ—Å—Ç–∞—Ç–∫–∏
start_sync(modules=['stock_balance', 'products_in_stock'])

# –¢–æ–ª—å–∫–æ —Å–≤–æ–π—Å—Ç–≤–∞
start_sync(modules=['properties'])
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Celery –∑–∞–¥–∞—á–∏

```bash
# –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏
docker-compose exec celery celery -A main inspect active

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
docker-compose exec celery celery -A main inspect stats
```

### –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

```bash
# –í—Å–µ –ª–æ–≥–∏ Celery
docker-compose logs -f celery

# –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
docker-compose logs -f celery | grep ERROR

# –¢–æ–ª—å–∫–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
docker-compose logs -f celery | grep sync
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS** –¥–ª—è –æ–±–º–µ–Ω–∞ —Å 1–°
2. **–°–æ–∑–¥–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è** —Ç–æ–ª—å–∫–æ –¥–ª—è 1–°
3. **–î–∞–π—Ç–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞** (—Ç–æ–ª—å–∫–æ `cml.add_exchange`)
4. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–æ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å**
5. **–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –ø–æ IP** (–≤ Nginx)

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –≤ Nginx:

```nginx
location ~* ^/(1c_exchange\.php|exchange) {
    # –†–∞–∑—Ä–µ—à–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å IP –∞–¥—Ä–µ—Å–∞ 1–° —Å–µ—Ä–≤–µ—Ä–∞
    allow 192.168.1.100;
    deny all;

    proxy_pass http://django;
    # ...
}
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤

```bash
# –£–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
docker-compose exec web find /app/media/cml/tmp -type f -mtime +7 -delete

# –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
docker-compose exec web rm -rf /app/media/cml/tmp/*
```

### –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

```bash
# –°–æ–∑–¥–∞—Ç—å –∞—Ä—Ö–∏–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
docker-compose exec web tar -czf /tmp/photos_backup.tar.gz /app/media/models/photos_1c/

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ö–æ—Å—Ç
docker cp metateks_web:/tmp/photos_backup.tar.gz ./
```

---

## ‚úÖ –ò—Ç–æ–≥–æ: –ß—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ò–∑ 1–° | –í 1–° | –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è |
|-----------|-------|------|-------------|
| –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ | ‚úÖ | ‚ùå | - |
| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ | ‚úÖ | ‚ùå | - |
| –ë—Ä–µ–Ω–¥—ã | ‚úÖ | ‚ùå | - |
| –¢–æ–≤–∞—Ä—ã | ‚úÖ | ‚ùå | ‚úÖ –î–∞ |
| –¶–µ–Ω—ã | ‚úÖ | ‚ùå | - |
| –°–∫–ª–∞–¥—ã | ‚úÖ | ‚ùå | - |
| –û—Å—Ç–∞—Ç–∫–∏ | ‚úÖ | ‚ùå | - |
| –ó–∞–∫–∞–∑—ã | ‚ùå | ‚úÖ | - |

**–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!** üì∏
