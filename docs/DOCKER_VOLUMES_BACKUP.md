# –ë—ç–∫–∞–ø –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Docker Volumes

## üì¶ –ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ

### Docker Volumes (—É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è Docker)

| Volume | –ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | –†–∞–∑–º–µ—Ä |
|--------|-----------|-------------|--------|
| `postgres_data` | –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL (—Ç–∞–±–ª–∏—Ü—ã, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∑–∞–∫–∞–∑—ã, —Ç–æ–≤–∞—Ä—ã) | ‚ö†Ô∏è **–ö—Ä–∏—Ç–∏—á–Ω–æ** | ~500MB+ |
| `redis_data` | –ö–µ—à Redis, –æ—á–µ—Ä–µ–¥–∏ Celery | ‚öôÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º–æ | –ú–∞–ª–æ |
| `static_volume` | –°–æ–±—Ä–∞–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏–∫–∞ (CSS, JS) | ‚úì –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º–æ | ~10MB |

**–ì–¥–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏:** `/var/lib/docker/volumes/<project>_<volume_name>/_data`

### Bind Mounts (–ø–∞–ø–∫–∏ –Ω–∞ –¥–∏—Å–∫–µ)

| –ü–∞–ø–∫–∞ | –ß—Ç–æ —Ö—Ä–∞–Ω–∏—Ç | –í Git? | –†–∞–∑–º–µ—Ä |
|-------|-----------|--------|--------|
| `./media/` | –§–æ—Ç–æ —Ç–æ–≤–∞—Ä–æ–≤, –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | ‚ùå –ù–µ—Ç | 1.7GB |
| `./logs/` | –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | ‚ùå –ù–µ—Ç | ~16KB |
| `./docker/nginx/` | –ö–æ–Ω—Ñ–∏–≥–∏ nginx | ‚úÖ –î–∞ | –ú–∞–ª–æ |

---

## üíæ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞

### –ë—ã—Å—Ç—Ä—ã–π –±—ç–∫–∞–ø (–≤—Å—ë –≤ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ)

```bash
./scripts/backup_volumes.sh
```

**–ß—Ç–æ —Å–æ–∑–¥–∞—ë—Ç—Å—è:**
```
backups/20251226_173000/
‚îú‚îÄ‚îÄ database.sql              # –î–∞–º–ø –ë–î —á–µ—Ä–µ–∑ pg_dump (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
‚îú‚îÄ‚îÄ postgres_volume.tar.gz    # –ü–æ–ª–Ω–∞—è –∫–æ–ø–∏—è PostgreSQL volume
‚îú‚îÄ‚îÄ redis_volume.tar.gz       # –ö–æ–ø–∏—è Redis volume
‚îú‚îÄ‚îÄ static_volume.tar.gz      # –ö–æ–ø–∏—è —Å—Ç–∞—Ç–∏–∫–∏
‚îú‚îÄ‚îÄ media.tar.gz              # –ê—Ä—Ö–∏–≤ –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤ (1.7GB)
‚îú‚îÄ‚îÄ logs.tar.gz               # –ê—Ä—Ö–∏–≤ –ª–æ–≥–æ–≤
‚îî‚îÄ‚îÄ env.docker.backup         # –ö–æ–ø–∏—è .env —Ñ–∞–π–ª–∞ (‚ö†Ô∏è —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–∞—Ä–æ–ª–∏!)
```

### –†—É—á–Ω–æ–π –±—ç–∫–∞–ø –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

#### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (pg_dump - –ª—É—á—à–∏–π –º–µ—Ç–æ–¥)

```bash
# –°–æ–∑–¥–∞—Ç—å SQL –¥–∞–º–ø
docker exec metateks_db pg_dump -U metateks metateks > backup_db.sql

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –¥–∞–º–ø–∞
docker exec -i metateks_db psql -U metateks metateks < backup_db.sql
```

#### 2. PostgreSQL Volume (–ø–æ–ª–Ω–∞—è –∫–æ–ø–∏—è —Ñ–∞–π–ª–æ–≤ –ë–î)

```bash
# –ë—ç–∫–∞–ø
docker run --rm \
  -v 728bf..._postgres_data:/data \
  -v $(pwd)/backups:/backup \
  alpine tar czf /backup/postgres.tar.gz -C /data .

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
docker volume create 728bf..._postgres_data
docker run --rm \
  -v 728bf..._postgres_data:/data \
  -v $(pwd)/backups:/backup \
  alpine sh -c "cd /data && tar xzf /backup/postgres.tar.gz"
```

#### 3. Redis Volume

```bash
# –ë—ç–∫–∞–ø
docker run --rm \
  -v 728bf..._redis_data:/data \
  -v $(pwd)/backups:/backup \
  alpine tar czf /backup/redis.tar.gz -C /data .
```

#### 4. Media —Ñ–∞–π–ª—ã (bind mount - –ø—Ä–æ—Å—Ç–æ –∞—Ä—Ö–∏–≤–∏—Ä—É–µ–º)

```bash
# –ë—ç–∫–∞–ø
tar czf backups/media_$(date +%Y%m%d).tar.gz media/

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
tar xzf backups/media_20251226.tar.gz
```

---

## ‚ôªÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞

### –ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

```bash
./scripts/restore_volumes.sh backups/20251226_173000
```

–°–∫—Ä–∏–ø—Ç —Å–ø—Ä–æ—Å–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —à–∞–≥–æ–º.

### –ß–∞—Å—Ç–∏—á–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

#### –¢–æ–ª—å–∫–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker compose down

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –ë–î
docker compose up -d db
sleep 10

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –¥–∞–º–ø–∞
docker exec -i metateks_db psql -U metateks -c "DROP DATABASE IF EXISTS metateks;"
docker exec -i metateks_db psql -U metateks -c "CREATE DATABASE metateks;"
docker exec -i metateks_db psql -U metateks metateks < backups/20251226_173000/database.sql

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
docker compose up -d
```

#### –¢–æ–ª—å–∫–æ media —Ñ–∞–π–ª—ã

```bash
rm -rf media/
tar xzf backups/20251226_173000/media.tar.gz
```

---

## üóìÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±—ç–∫–∞–ø (cron)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞

```bash
# –û—Ç–∫—Ä—ã—Ç—å crontab
crontab -e

# –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É (–±—ç–∫–∞–ø –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 –Ω–æ—á–∏)
0 3 * * * cd /path/to/project && ./scripts/backup_volumes.sh >> backups/cron.log 2>&1
```

### –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)

```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ crontab
0 4 * * * find /path/to/project/backups -type d -mtime +7 -exec rm -rf {} \;
```

---

## üì§ –ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–µ—Ä

### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ –∞—Ä—Ö–∏–≤

```bash
# –ù–∞ —Å—Ç–∞—Ä–æ–º —Å–µ—Ä–≤–µ—Ä–µ
./scripts/backup_volumes.sh
tar czf full_backup.tar.gz backups/20251226_173000/

# –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ full_backup.tar.gz –Ω–∞ –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä

# –ù–∞ –Ω–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ
tar xzf full_backup.tar.gz
./scripts/restore_volumes.sh backups/20251226_173000/
```

### –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ rsync

```bash
# –° –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã–π
rsync -avz --progress \
  backups/ \
  user@remote:/path/to/project/backups/

# –ù–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
./scripts/restore_volumes.sh backups/20251226_173000/
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –ß—Ç–æ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –±—ç–∫–∞–ø–∏—Ç—å

1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** (`postgres_data` –∏–ª–∏ `database.sql`) - –∫—Ä–∏—Ç–∏—á–Ω–æ!
2. **Media —Ñ–∞–π–ª—ã** (`./media/`) - —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–æ–≤, –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** (`.env.docker`) - –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫

### –ß—Ç–æ –º–æ–∂–Ω–æ –ù–ï –±—ç–∫–∞–ø–∏—Ç—å

1. `redis_data` - –∫–µ—à –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å
2. `static_volume` - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `collectstatic`
3. `logs/` - —Å–ª—É–∂–µ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **–§–∞–π–ª `.env.docker` —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–∞—Ä–æ–ª–∏!** –•—Ä–∞–Ω–∏—Ç–µ –±—ç–∫–∞–ø—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ
- –ù–µ –∫–æ–º–º–∏—Ç—å—Ç–µ –±—ç–∫–∞–ø—ã –≤ Git (–æ–Ω–∏ –≤ `.gitignore`)
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤

### –†–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–∞

–¢–∏–ø–∏—á–Ω—ã–π –±—ç–∫–∞–ø:
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: 50-500MB
- Media: 1-10GB
- –û—Å—Ç–∞–ª—å–Ω–æ–µ: <100MB

**–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä: ~1.5-10GB**

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –±—ç–∫–∞–ø–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ
ls -lh backups/20251226_173000/

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∞—Ä—Ö–∏–≤—ã –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã
tar tzf backups/20251226_173000/media.tar.gz > /dev/null && echo "OK"
tar tzf backups/20251226_173000/postgres_volume.tar.gz > /dev/null && echo "OK"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SQL –¥–∞–º–ø
head -20 backups/20251226_173000/database.sql
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Docker Volumes Documentation](https://docs.docker.com/storage/volumes/)
- [PostgreSQL Backup and Restore](https://www.postgresql.org/docs/current/backup.html)
- –î—Ä—É–≥–∏–µ –≥–∞–π–¥—ã: `docs/README.md`
